name: Attest

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
    branches:
      - master
  release:
    types: [published]
  schedule:
    # Run weekly on Mondays at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      container_tag:
        description: 'Container tag to attest (default: latest)'
        required: false
        default: 'latest'

env:
  NODE_VERSION: '23.0.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/git-garden

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'release' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create ops/attest directories
        run: |
          mkdir -p ops/attest/sbom
          mkdir -p ops/attest/provenance
          mkdir -p ops/attest/signatures
      
      - name: Generate SBOM (SPDX format)
        run: |
          # Generate SBOM using npm
          npm sbom --sbom-format spdx > ops/attest/sbom/sbom.spdx.json
          
          echo "âœ… SBOM generated in SPDX format"
      
      - name: Install CycloneDX for additional SBOM format
        run: npm install -g @cyclonedx/cyclonedx-npm
      
      - name: Generate SBOM (CycloneDX format)
        run: |
          cyclonedx-npm --output-file ops/attest/sbom/sbom.cyclonedx.json
          
          echo "âœ… SBOM generated in CycloneDX format"
      
      - name: Generate dependency hash
        run: |
          sha256sum package-lock.json > ops/attest/signatures/package-lock.sha256
          
          echo "Package lock hash:"
          cat ops/attest/signatures/package-lock.sha256
      
      - name: SBOM summary
        run: |
          echo "## ðŸ“¦ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Created:" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops/attest/sbom/sbom.spdx.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops/attest/sbom/sbom.cyclonedx.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ops/attest/signatures/package-lock.sha256\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ops/attest/sbom/sbom.spdx.json ]; then
            PACKAGE_COUNT=$(jq '.packages | length' ops/attest/sbom/sbom.spdx.json)
            echo "### Statistics:" >> $GITHUB_STEP_SUMMARY
            echo "- Total packages: $PACKAGE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-files
          path: ops/attest/
          retention-days: 90

  attest-container:
    name: Attest Container
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine container tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="${{ github.event.inputs.container_tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Container tag: $TAG"
      
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman
          podman --version
      
      - name: Log in to Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
      
      - name: Pull container image
        run: |
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          
          echo "âœ… Container pulled successfully"
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Sign container image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          
          echo "âœ… Container signed with cosign"
      
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-files
          path: ops/attest/
      
      - name: Attest SBOM to container
        uses: actions/attest-sbom@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.tag.outputs.tag }}
          sbom-path: 'ops/attest/sbom/sbom.spdx.json'
          push-to-registry: true
      
      - name: Generate provenance attestation
        run: |
          # Create provenance document
          cat > ops/attest/provenance/provenance.json << EOF
          {
            "builder": {
              "id": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            },
            "buildType": "https://github.com/Attestations/GitHubActionsWorkflow@v1",
            "invocation": {
              "configSource": {
                "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                "digest": {
                  "sha256": "${{ github.sha }}"
                },
                "entryPoint": ".github/workflows/attest.yml"
              }
            },
            "metadata": {
              "buildInvocationId": "${{ github.run_id }}",
              "buildStartedOn": "${{ github.event.repository.pushed_at }}",
              "completeness": {
                "parameters": true,
                "environment": true,
                "materials": true
              },
              "reproducible": false
            },
            "materials": [
              {
                "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                "digest": {
                  "sha256": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF
          
          echo "âœ… Provenance document created"
      
      - name: Verify container signature
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} || true
          
          echo "âœ… Verification complete"
      
      - name: Attest summary
        run: |
          echo "## ðŸ” Container Attestation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Attestations:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container signed with Cosign" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SBOM attached" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Provenance document generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Verify signature" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp='https://github.com/${{ github.repository }}/*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer=https://token.actions.githubusercontent.com \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: generate-sbom
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: |
          npm audit --json > audit-report.json || true
          
          echo "## ðŸ” Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f audit-report.json ]; then
            VULNERABILITIES=$(jq '.metadata.vulnerabilities' audit-report.json)
            echo "### Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$VULNERABILITIES" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-report.json
          retention-days: 90

  attestation-summary:
    name: Attest Summary
    runs-on: ubuntu-latest
    needs: [generate-sbom, attest-container, security-scan]
    if: always()
    
    steps:
      - name: Final summary
        run: |
          echo "## ðŸ“‹ Attestation Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.generate-sbom.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Attestation | ${{ needs.attest-container.result == 'success' && 'âœ…' || needs.attest-container.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

