name: Release

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches:
      - master
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '23.0.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/git-garden

permissions:
  contents: write
  packages: write

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
      - name: Validate version tag format
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Release tag: $TAG"
          
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Invalid version tag format. Expected: v1.0.0"
            exit 1
          fi
          
          echo "âœ… Valid version tag"
          echo "TAG=$TAG" >> $GITHUB_ENV

  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    needs: validate-tag
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Type check
        run: npm run check
      
      - name: Build production
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/public/
          retention-days: 30

  build-and-publish-containers:
    name: Build and Publish Containers
    runs-on: ubuntu-latest
    needs: test-and-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f1-2)
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          
          echo "Release version: $VERSION"
          echo "Major: $MAJOR"
          echo "Minor: $MINOR"
      
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman
          podman --version
      
      - name: Build production container
        run: |
          podman build \
            -f ops/build/master.Containerfile \
            -t git-garden:${{ steps.version.outputs.tag }} \
            -t git-garden:${{ steps.version.outputs.minor }} \
            -t git-garden:${{ steps.version.outputs.major }} \
            -t git-garden:latest \
            .
      
      - name: Test container
        run: |
          # Start container
          podman run -d --name release-test \
            -p 8080:80 \
            git-garden:${{ steps.version.outputs.tag }}
          
          # Wait for nginx
          sleep 3
          
          # Test endpoint
          curl -f http://localhost:8080/ || exit 1
          
          echo "âœ… Container test passed"
          
          # Cleanup
          podman stop release-test
          podman rm release-test
      
      - name: Log in to Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
      
      - name: Tag containers for registry
        run: |
          # Tag all versions for registry
          podman tag git-garden:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
          
          podman tag git-garden:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.minor }}
          
          podman tag git-garden:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.major }}
          
          podman tag git-garden:${{ steps.version.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Push containers to registry
        run: |
          echo "Pushing containers to ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.minor }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.major }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "âœ… All container tags pushed successfully"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-publish-containers
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist/public/
      
      - name: Create release archive
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          tar -czf git-garden-${TAG}-dist.tar.gz -C dist/public .
          cd dist/public && zip -r ../../git-garden-${TAG}-dist.zip . && cd ../..
      
      - name: Generate changelog
        id: changelog
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            CHANGELOG="Initial release of Git Garden"
          else
            echo "Generating changelog from $PREV_TAG to $TAG"
            CHANGELOG=$(git log ${PREV_TAG}..${TAG} --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save changelog to file
          echo "$CHANGELOG" > CHANGELOG.txt
          
          # Create release notes
          cat > RELEASE_NOTES.md << EOF
          ## Git Garden ${TAG}
          
          ### ðŸ“¦ Container Images
          
          Available at GitHub Container Registry:
          \`\`\`bash
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}
          \`\`\`
          
          ### ðŸš€ Running
          
          \`\`\`bash
          podman run -p 8080:80 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}
          \`\`\`
          
          ### ðŸ“ Changes
          
          $CHANGELOG
          
          ### ðŸ”— Links
          
          - [Container Registry](https://github.com/${{ github.repository_owner }}/ts-git-garden/pkgs/container/git-garden)
          - [Documentation](https://github.com/${{ github.repository }}/blob/master/README.md)
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            git-garden-*.tar.gz
            git-garden-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release summary
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "## ðŸŽ‰ Release $TAG Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Images Published:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Start:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "podman run -p 8080:80 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

