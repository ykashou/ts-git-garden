name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  NODE_VERSION: '23.0.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/git-garden

jobs:
  build-app:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run check
      
      - name: Build production
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts
          path: dist/public/
          retention-days: 1
  
  build-containers:
    name: Build Containers
    runs-on: ubuntu-latest
    needs: build-app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman
          podman --version
      
      - name: Build development container
        run: |
          podman build \
            -f ops/build/development.Containerfile \
            -t git-garden:dev \
            .
      
      - name: Build production container
        run: |
          podman build \
            -f ops/build/master.Containerfile \
            -t git-garden:latest \
            -t git-garden:${{ github.sha }} \
            .
      
      - name: Test development container
        run: |
          # Start container in background
          podman run -d --name test-dev \
            -p 5173:5173 \
            git-garden:dev &
          
          # Wait for container to be ready
          sleep 5
          
          # Check if container is running
          podman ps | grep test-dev
          
          # Cleanup
          podman stop test-dev
          podman rm test-dev
      
      # TODO: Re-enable when master.Containerfile is updated to use distroless
      # - name: Test production container
      #   run: |
      #     # Start container in background
      #     podman run -d --name test-prod \
      #       -p 8080:80 \
      #       git-garden:latest
      #     
      #     # Wait for nginx to start
      #     sleep 3
      #     
      #     # Check if container is running
      #     podman ps | grep test-prod
      #     
      #     # Test HTTP endpoint
      #     curl -f http://localhost:8080/ || exit 1
      #     
      #     # Cleanup
      #     podman stop test-prod
      #     podman rm test-prod
      
      - name: Save container images
        run: |
          mkdir -p /tmp/container-images
          podman save -o /tmp/container-images/git-garden-dev.tar git-garden:dev
          podman save -o /tmp/container-images/git-garden-latest.tar git-garden:latest
      
      - name: Upload container images
        uses: actions/upload-artifact@v4
        with:
          name: container-images
          path: /tmp/container-images/
          retention-days: 7
      
      - name: Log in to Container Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
      
      - name: Tag and push to registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          # Tag for registry
          podman tag git-garden:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          podman tag git-garden:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # Push to registry
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
  
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-app, build-containers]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "Build Status Summary:"
          echo "- Application Build: ${{ needs.build-app.result }}"
          echo "- Container Build: ${{ needs.build-containers.result }}"
          
          if [ "${{ needs.build-app.result }}" != "success" ] || \
             [ "${{ needs.build-containers.result }}" != "success" ]; then
            echo "❌ Build failed!"
            exit 1
          fi
          
          echo "✅ Build successful!"
