---
description: Ops structure for TypeScript/React/Vite UI applications - container-only builds
alwaysApply: true
---

# Ops Structure for TypeScript/React/Vite Projects

## Directory Structure:

```
${PROJECT_NAME}/
├── ops/
│   ├── build/
│   │   ├── development.Containerfile
│   │   ├── master.Containerfile
│   │   └── README.md
│   ├── test/
│   │   └── README.md
│   ├── release/
│   │   ├── release-config.yaml
│   │   ├── release.sh
│   │   ├── version-bump.sh
│   │   └── README.md
│   └── attest/
│       ├── provenance/
│       ├── sbom/
│       ├── signatures/
│       └── README.md
└── .github/
    └── workflows/
        ├── build.yml
        ├── test.yml
        ├── release.yml
        └── attest.yml
```

## Build Operations (Container-Only)

### development.Containerfile:
```dockerfile
FROM node:${NODE_VERSION}-alpine AS development

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm install

# Copy source
COPY . .

# Expose Vite dev server port
EXPOSE ${PORT_DEV}

# Run dev server
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### master.Containerfile (Multi-stage Production):
```dockerfile
# Build stage
FROM node:${NODE_VERSION}-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Build for production (builds both frontend and backend)
RUN npm run build

# Production stage - TRUE DISTROLESS (FROM scratch)
FROM scratch

WORKDIR /app

# Copy Node.js binary and essential libraries from Alpine
COPY --from=builder /usr/local/bin/node /usr/local/bin/node
COPY --from=builder /lib/ld-musl-x86_64.so.1 /lib/ld-musl-x86_64.so.1
COPY --from=builder /usr/lib/libstdc++.so.6 /usr/lib/libstdc++.so.6
COPY --from=builder /usr/lib/libgcc_s.so.1 /usr/lib/libgcc_s.so.1

# Copy built application
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/public ./public

ENV NODE_ENV=production
ENV PORT=${PORT_PROD}

EXPOSE ${PORT_PROD}

# Run Node.js backend (serves both API and static frontend)
ENTRYPOINT ["/usr/local/bin/node"]
CMD ["dist/index.js"]
```

### Build Commands (ALWAYS use podman):
```bash
# Development
podman build -f ops/build/development.Containerfile -t ${CONTAINER_NAME}:dev .
podman run --rm -p ${PORT_DEV}:${PORT_DEV} -v $(pwd):/app ${CONTAINER_NAME}:dev

# Production
podman build -f ops/build/master.Containerfile -t ${CONTAINER_NAME}:latest .
podman run --rm -p ${PORT_PROD}:${PORT_PROD} ${CONTAINER_NAME}:latest
```

## Test Operations

### Test Structure:
- Unit tests: Vitest
- Component tests: React Testing Library
- E2E tests: Playwright (optional)

### Test Commands:
```bash
# Unit tests
npm test

# With coverage
npm test -- --coverage

# E2E tests
npm run test:e2e
```

### Test in Container:
```bash
podman run --rm ${CONTAINER_NAME}:dev npm test
```

## Release Operations

### release-config.yaml:
```yaml
version: 1.0.0
project_name: ${CONTAINER_NAME}
description: ${PROJECT_DESCRIPTION}

container:
  registry: ${REGISTRY}/${GITHUB_OWNER}
  namespace: ${CONTAINER_NAME}
  tags:
    - latest
    - "{{ .Version }}"
    - "{{ .Major }}.{{ .Minor }}"

platforms:
  - linux/amd64
  - linux/arm64

metadata:
  authors:
    - ${GITHUB_OWNER}
  license: ${LICENSE}
  homepage: https://github.com/${GITHUB_OWNER}/${REPO_NAME}
```

### release.sh (Shell Script - NO Python):
```bash
#!/bin/bash
set -euo pipefail

VERSION="${1:-}"
if [ -z "$VERSION" ]; then
    echo "Usage: $0 v1.0.0"
    exit 1
fi

# Validate version format
if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid version format. Use v1.0.0"
    exit 1
fi

# Run tests
npm test

# Build production
npm run build

# Build container
podman build -f ops/build/master.Containerfile \
    -t ${CONTAINER_NAME}:${VERSION} \
    -t ${CONTAINER_NAME}:latest .

# Tag for registry
podman tag ${CONTAINER_NAME}:${VERSION} ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:${VERSION}
podman tag ${CONTAINER_NAME}:latest ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:latest

# Create git tag
git tag -a "${VERSION}" -m "Release ${VERSION}"

echo "✅ Release ${VERSION} complete"
echo "Next: podman push ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:${VERSION}"
echo "Next: podman push ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:latest"
```

## Attest Operations

### Supply Chain Attestation:

#### Generate SBOM (Software Bill of Materials):
```bash
# Generate SBOM for dependencies
npm sbom --output-format spdx > ops/attest/sbom/sbom.spdx.json

# Or using cyclonedx
npx @cyclonedx/cyclonedx-npm --output-file ops/attest/sbom/sbom.cyclonedx.json
```

#### Container Attestation:
```bash
# Sign container image
cosign sign ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:v1.0.0

# Generate provenance
cosign attest --predicate ops/attest/provenance/provenance.json \
    ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:v1.0.0

# Verify signature
cosign verify ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:v1.0.0
```

#### Dependency Attestation:
```bash
# Audit dependencies
npm audit

# Generate lock file hash
sha256sum package-lock.json > ops/attest/signatures/package-lock.sha256

# Sign package-lock.json
gpg --detach-sign --armor package-lock.json
```

#### GitHub Attestations:
```bash
# Attest build provenance (GitHub CLI)
gh attestation verify oci://${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:v1.0.0
```

## GitHub Workflows

### build.yml Requirements:
- Node.js version: ${NODE_VERSION}
- Cache npm dependencies
- Run `npm ci` for workflow installs
- Build production: `npm run build`
- Install podman (NOT docker)
- Build both development and production containers
- Test containers locally
- Upload build artifacts (retention: 1 day)
- Upload container images (retention: 7 days)
- No GHCR publishing (handled by release.yml)

### test.yml Requirements:
- Run after build completes (on master) or on PR
- Run unit tests: `npm test -- --coverage`
- Run linting: `npm run lint` (if exists)
- Check TypeScript: `npm run check`
- Test production build locally
- Upload coverage reports

### attest.yml Requirements (Supply Chain):
- Generate SBOM from package-lock.json
- Sign container images with cosign
- Create build provenance attestation
- Verify dependencies hash
- Upload attestations to repository
- Use GitHub's attestation API
- Run on: release tags, schedule (weekly)

**Key Steps:**
```yaml
- name: Generate SBOM
  run: npm sbom --output-format spdx > sbom.spdx.json

- name: Sign container
  run: cosign sign ${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:${{ github.sha }}

- name: Attest provenance
  run: |
    gh attestation attest \
      --predicate-type https://slsa.dev/provenance/v1 \
      oci://${REGISTRY}/${GITHUB_OWNER}/${CONTAINER_NAME}:${{ github.sha }}
```

### Key Differences from Go Projects:
- ❌ No binary compilation
- ✅ Container-only builds
- ✅ Distroless Node.js runtime (FROM scratch)
- ✅ Multi-stage build (node builder + distroless runtime)
- ✅ Port exposure: ${PORT_DEV} (dev), ${PORT_PROD} (prod)
- ✅ SBOM from npm packages (not Go modules)