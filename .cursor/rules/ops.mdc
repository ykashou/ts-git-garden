---
description: Ops structure for TypeScript/React/Vite UI applications - container-only builds
alwaysApply: true
---

# Ops Structure for ts-git-garden

## Directory Structure:

```
ts-git-garden/
├── ops/
│   ├── build/
│   │   ├── development.Containerfile
│   │   ├── master.Containerfile
│   │   └── README.md
│   ├── test/
│   │   └── README.md
│   ├── release/
│   │   ├── release-config.yaml
│   │   ├── release.sh
│   │   ├── version-bump.sh
│   │   └── README.md
│   └── attest/
│       ├── provenance/
│       ├── sbom/
│       ├── signatures/
│       └── README.md
└── .github/
    └── workflows/
        ├── build.yml
        ├── test.yml
        ├── release.yml
        └── attest.yml
```

## Build Operations (Container-Only)

### development.Containerfile:
```dockerfile
FROM node:23.0.0-alpine AS development

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source
COPY . .

# Expose Vite dev server port
EXPOSE 5173

# Run dev server
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### master.Containerfile (Multi-stage Production):
```dockerfile
# Build stage
FROM node:23.0.0-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Build for production
RUN npm run build

# Production stage
FROM nginx:alpine

# Copy built assets from builder
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy custom nginx config if needed
# COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### Build Commands (ALWAYS use podman):
```bash
# Development
podman build -f ops/build/development.Containerfile -t git-garden:dev .
podman run --rm -p 5173:5173 -v $(pwd):/app git-garden:dev

# Production
podman build -f ops/build/master.Containerfile -t git-garden:latest .
podman run --rm -p 8080:80 git-garden:latest
```

## Test Operations

### Test Structure:
- Unit tests: Vitest
- Component tests: React Testing Library
- E2E tests: Playwright (optional)

### Test Commands:
```bash
# Unit tests
npm test

# With coverage
npm test -- --coverage

# E2E tests
npm run test:e2e
```

### Test in Container:
```bash
podman run --rm git-garden:dev npm test
```

## Release Operations

### release-config.yaml:
```yaml
version: 1.0.0
project_name: git-garden
description: Developer portfolio showcase with 3D GitHub visualization

container:
  registry: ghcr.io/ykashou
  namespace: git-garden
  tags:
    - latest
    - "{{ .Version }}"
    - "{{ .Major }}.{{ .Minor }}"

platforms:
  - linux/amd64
  - linux/arm64

metadata:
  authors:
    - ykashou
  license: ACE
  homepage: https://github.com/ykashou/ts-git-garden
```

### release.sh (Shell Script - NO Python):
```bash
#!/bin/bash
set -euo pipefail

VERSION="${1:-}"
if [ -z "$VERSION" ]; then
    echo "Usage: $0 v1.0.0"
    exit 1
fi

# Validate version format
if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid version format. Use v1.0.0"
    exit 1
fi

# Run tests
npm test

# Build production
npm run build

# Build container
podman build -f ops/build/master.Containerfile \
    -t git-garden:${VERSION} \
    -t git-garden:latest .

# Tag for registry
podman tag git-garden:${VERSION} ghcr.io/ykashou/git-garden:${VERSION}
podman tag git-garden:latest ghcr.io/ykashou/git-garden:latest

# Create git tag
git tag -a "${VERSION}" -m "Release ${VERSION}"

echo "✅ Release ${VERSION} complete"
echo "Next: podman push ghcr.io/ykashou/git-garden:${VERSION}"
echo "Next: podman push ghcr.io/ykashou/git-garden:latest"
```

## Attest Operations

### Supply Chain Attestation:

#### Generate SBOM (Software Bill of Materials):
```bash
# Generate SBOM for dependencies
npm sbom --output-format spdx > ops/attest/sbom/sbom.spdx.json

# Or using cyclonedx
npx @cyclonedx/cyclonedx-npm --output-file ops/attest/sbom/sbom.cyclonedx.json
```

#### Container Attestation:
```bash
# Sign container image
cosign sign ghcr.io/ykashou/git-garden:v1.0.0

# Generate provenance
cosign attest --predicate ops/attest/provenance/provenance.json \
    ghcr.io/ykashou/git-garden:v1.0.0

# Verify signature
cosign verify ghcr.io/ykashou/git-garden:v1.0.0
```

#### Dependency Attestation:
```bash
# Audit dependencies
npm audit

# Generate lock file hash
sha256sum package-lock.json > ops/attest/signatures/package-lock.sha256

# Sign package-lock.json
gpg --detach-sign --armor package-lock.json
```

#### GitHub Attestations:
```bash
# Attest build provenance (GitHub CLI)
gh attestation verify oci://ghcr.io/ykashou/git-garden:v1.0.0
```

## GitHub Workflows

### build.yml Requirements:
- Node.js version: 23.0.0
- Cache npm dependencies
- Run `npm ci` (not `npm install`)
- Build production: `npm run build`
- Install podman (NOT docker)
- Build both development and production containers
- Upload build artifacts (retention: 1 day)
- Upload container images (retention: 7 days)

### test.yml Requirements:
- Run after build completes
- Download build artifacts
- Run unit tests: `npm test -- --coverage`
- Run linting: `npm run lint`
- Check TypeScript: `npm run type-check`
- Test production build locally
- Upload coverage reports

### attest.yml Requirements (Supply Chain):
- Generate SBOM from package-lock.json
- Sign container images with cosign
- Create build provenance attestation
- Verify dependencies hash
- Upload attestations to repository
- Use GitHub's attestation API
- Run on: release tags, schedule (weekly)

**Key Steps:**
```yaml
- name: Generate SBOM
  run: npm sbom --output-format spdx > sbom.spdx.json

- name: Sign container
  run: cosign sign ghcr.io/ykashou/git-garden:${{ github.sha }}

- name: Attest provenance
  run: |
    gh attestation attest \
      --predicate-type https://slsa.dev/provenance/v1 \
      oci://ghcr.io/ykashou/git-garden:${{ github.sha }}
```

### Key Differences from Go Projects:
- ❌ No binary compilation
- ✅ Container-only builds
- ✅ Uses nginx for serving static files
- ✅ Multi-stage build (node builder + nginx runtime)
- ✅ Different port exposure (5173 dev, 80 prod)
- ✅ SBOM from npm packages (not Go modules)